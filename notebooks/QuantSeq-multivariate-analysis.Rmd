---
title: "QuantSeq-Initial-Look"
output: html_document
---
### Install libraries and source scripts 
```{r}
library(pastecs)
library(vegan)
source("references//biostats.R")
```

### Import QuantSeq sample key
```{r}
key <- read.csv("data/quantseq_key.csv", header=T, na.strings = NA)
key$stage <- as.factor(key$stage)
key$temperature <- as.factor(key$temperature)
key$filename <- as.character(key$filename)
```

### Import counts matrix file as dataframe. 
```{r}
counts <- data.frame(read.table("results/kallisto/1129matrix-trans_counts.isoform.counts.matrix", header = T, stringsAsFactors = F, fill = FALSE))
print(paste("number of samples:", ncol(counts), sep=" "))
print(paste("number of genes in dataframe:", nrow(counts), sep=" "))
```

### Transpose dataframe so each row = a sample (aka "objects"), and each column = genes (aka "variables") 
```{r}
counts.t <- t(counts) #transform data to have each sample a row, each column a gene 
```

### Remove genes that don't show up in any samples (why are they here?)
```{r}
100*(1/nrow(counts.t)) #if just one sample had a gene, what would that % be? 4.1666. Use below to drop. 
counts.ts <- drop.var(counts.t, min.po = 4)
print(paste("# of genes not present in samples & dropped:", ncol(counts.t) - ncol(counts.ts), sep=" "))
ncol(counts.ts) #number of contigs/genes in dataset 
```

### Remove extraneous text from sample names
```{r}
rownames(counts.ts) <- gsub("CP.KS.LibL.", "", rownames(counts.ts))
rownames(counts.ts) <- gsub("_L006_R1_001", "", rownames(counts.ts))
rownames(counts.ts) #confirm that it worked
```

## Use foa.plots to visualize data a bit: 

In how many samples does each gene occur? 
  - The first four plots portray the gene’ frequency of occurrence among samples in a number of different ways – either as an empirical cumulative distribution function (ECDF) of gene occurrence or as a histogram of gene occurrence. 

What is the mean abundance of each gene when it occurs (not averaging zeros for samples where it is absent)? 
  - The fifth plot is an ECDF of gene mean abundance. X-axis is samples, ranked from 1-n in terms of mean gene abundance. 

Is the mean abundance of genes correlated with the number of samples they occur in? 
  - The sixth plot is a scatter plot of frequency of occurrence against mean abundance. Is there any apparent relationship between the two? Are the widespread genes also generally more abundant? Are there many widespread genes that occur at low abundance? Conversely, are there genes much less widespread, but abundant where they occur?

Is the total abundance of gene in a sample correlated with the number of gene in a sample? To answer this question, first it is instructive to look at the number of gene per sample. 
  - The eighth plot depicts the ECDF of sample richness. Are there any interesting patterns? For example, do most samples support an average number of gene, while only a few samples supporting either very few or very many gene? Or is the pattern different?

Second, what is the pattern in the distribution of sample total abundance? 
  - The ninth plot is the ECDF of total sample abundance. How does it compare to the ECDF of sample richness?

Finally, to answer the question on the relation between total abundance and number of gene/sample ...
  - The last plot is a scatter plot of the two variables. Is there is relationship between the number of gene per sample and the total abundance? Do gene-rich samples generally have a greater total abundance of those genes as well? 

```{r}
foa.plots(counts.ts)
```
### Generate heat map for initial inspection

```{r}
counts.ts.mat <- data.matrix(counts.ts)
str(counts.ts.mat)

pheatmap(counts.ts.mat, Rowv=NA, Colv=NA, na.rm = TRUE, hclustfun = NA, xlab = NA, show_colnames =FALSE, cluster_cols = FALSE, cluster_rows = FALSE, scale="column", kmeans_k=NA, color=c("dodgerblue3", "goldenrod1"), main = "QuantSeq Counts, Gonad and Larval Tissues")
```

### Separate larvae and gonad samples into 2 dataframes, remove genes that aren't present in those samples
```{r}
counts.ts.gonad <- as.data.frame(counts.ts[grepl(".G_", rownames(counts.ts)), ])
counts.ts.larvae <- as.data.frame(counts.ts[grepl(".L_", rownames(counts.ts)), ])
counts.ts.gonad[,1:3]
counts.ts.larvae[,1:3]

# re-drop "genes" not present, calculate the number that were dropped (i.e. which were present in other tissue sample type) 
counts.ts.gonad.s <- drop.var(counts.ts.gonad , min.po = 1/17)
counts.ts.larvae.s <- drop.var(counts.ts.larvae, min.po = 1/9)
print(paste("# of genes not present in gonad samples & dropped:", ncol(counts.ts.gonad) - ncol(counts.ts.gonad.s), sep=" "))
print(paste("# of genes not present in larval samples & dropped:", ncol(counts.ts.larvae) - ncol(counts.ts.larvae.s), sep=" "))
ncol(counts.ts.gonad.s) # 13,002 in gonad samples (makes sense, gonad transcriptome was used)
ncol(counts.ts.larvae.s) #4,410 in larval samples 

write.csv(counts.ts.gonad.s, file="results/multivariate/gonad.counts.csv")
write.csv(counts.ts.larvae.s, file="results/multivariate/larvae.counts.csv")
```

## Drop genes with very little variability between all samples, using coefficient variation <5

NOTE: NONE DROPPED
```{r}
counts.ts.gonad.sv <- drop.var(counts.ts.gonad.s, min.cv=5) 
ncol(counts.ts.gonad.s) - ncol(counts.ts.gonad.sv) #number of contigs/genes dropped due to low variance .. none 

counts.ts.larvae.sv <- drop.var(counts.ts.larvae.s, min.cv=5) 
ncol(counts.ts.larvae.s) - ncol(counts.ts.larvae.sv) #number of contigs/genes dropped due to low variance .. none 
```

### Heat maps for gonad, larval tissues separately 

Clearly samples 13 and 3 have very low counts ... inspect later 

```{r}
# gonad
pdf(file="plots/heatmap-gonad.pdf", width = 5.5, height = 7.5)
pheatmap(counts.ts.gonad.s, Rowv=NA, Colv=NA, na.rm = TRUE, hclustfun = NA, xlab = NA, show_colnames =FALSE, cluster_cols = FALSE, scale="column", kmeans_k=NA, color=c("dodgerblue3", "goldenrod1"), main = "QuantSeq Counts, Gonad Tissue")
dev.off()

pdf(file="plots/heatmap-larvae.pdf", width = 5.5, height = 7.5)
#larval
pheatmap(counts.ts.larvae.s, Rowv=NA, Colv=NA, na.rm = TRUE, hclustfun = NA, xlab = NA, show_colnames =FALSE, cluster_cols = FALSE,  scale="column", kmeans_k=NA, color=c("dodgerblue3", "goldenrod1"), main = "QuantSeq Counts, Larval Tissue")
dev.off()
```


### Merge sample key info to count data, then sort, and generate heat map for initial inspection of gonad tissue samples
```{r}
# order columns by count 
countmns.gonad <- colMeans(counts.ts.gonad.s, na.rm=TRUE)
counts.ts.gonad.s <- counts.ts.gonad.s[,order(countmns.gonad)]

# merge count data with sample key 
counts.ts.gonad.s.a <- merge(y=counts.ts.gonad.s, x=key, by.y="row.names", by.x="filename") #merge 
counts.ts.gonad.s.a[,1:10] #check out results of merge

# reset row names as sample names
rownames(counts.ts.gonad.s.a) <- counts.ts.gonad.s.a[,1]  

# sort rows/smpls by pH
counts.ts.gonad.s.a <- with(counts.ts.gonad.s.a, counts.ts.gonad.s.a[order(pH),]) 

# extract matrix, create vector of pH 
counts.ts.gonad.s.a.mat <- data.matrix(counts.ts.gonad.s.a[,-1:-9])
pH <- c("gray30", "steelblue")[counts.ts.gonad.s.a$pH]

pheatmap(counts.ts.gonad.s.a.mat, Rowv=NA, Colv=NA, scale="column", annotation_row = pH, annotation_colors=c("steelblue", "gray30")) #red=low pH, blue=ambient pH genes sorted by average
```

# fix the heat map 
